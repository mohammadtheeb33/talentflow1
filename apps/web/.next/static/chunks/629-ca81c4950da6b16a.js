"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[629],{6629:function(e,t,n){n.d(t,{W:function(){return m}});var a=n(7437),o=n(2265),s=n(6410),l=n(5978),c=n(257);function i(){let e="cvchk-1a7e0",t=c.env.FIREBASE_EMULATORS_FUNCTIONS_PORT||"5001",n="https://us-central1-".concat(e,".cloudfunctions.net");return"http://localhost:".concat(t,"/").concat(e,"/us-central1"),[n]}async function r(e,t){let n=i(),a=null;for(let o of n){let n="".concat(o).concat(e);try{let e=await fetch(n,t);if(e.ok)return e;a=Error("HTTP ".concat(e.status," on ").concat(n))}catch(e){a=Error("".concat((null==e?void 0:e.message)||e," on ").concat(n))}}throw a||Error("Failed to fetch from any functions base")}async function d(e,t,n,a){let o=new URLSearchParams({uid:encodeURIComponent(e)});o.set("action","start"),t&&o.set("scopes",t),n&&o.set("force_consent","1"),a&&o.set("tenant",a);let s=await r("/outlookOAuth?".concat(o.toString()),{method:"GET"});if(!s.ok){let e="Failed to start OAuth (".concat(s.status,")");try{let t=await s.json();e=(null==t?void 0:t.error)||e}catch(e){}throw Error(e)}return await s.json()}async function u(e){let t=i(),n="/outlookOAuth?action=status&uid=".concat(encodeURIComponent(e),"&details=1"),a=null,o=null;for(let e of t)try{let t=await fetch("".concat(e).concat(n),{method:"GET"}),o=await t.json();if(o&&o.connected)return o;a=o}catch(e){o=e}if(a)return a;if(o)throw o;return{connected:!1}}async function x(e,t,n,a){let o={uid:e,from:t,to:n};(null==a?void 0:a.fileType)&&(o.fileType=a.fileType),(null==a?void 0:a.folder)&&(o.folder=a.folder),(null==a?void 0:a.jobProfileId)&&(o.jobProfileId=a.jobProfileId);let s=await r("/fetchAttachments",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});if(!s.ok){let e="Failed to fetch attachments (".concat(s.status,")");try{let t=await s.json();e=(null==t?void 0:t.error)||e}catch(e){}throw Error(e)}return await s.json()}function m(e){let{isOpen:t,onClose:n}=e,[c,r]=(0,o.useState)(null),[m,h]=(0,o.useState)(!1),[f,g]=(0,o.useState)(!1),[p,v]=(0,o.useState)(void 0),[j,b]=(0,o.useState)(void 0),[y,w]=(0,o.useState)(""),[N,C]=(0,o.useState)(""),[S,k]=(0,o.useState)(!1),[T,E]=(0,o.useState)(null),[A,O]=(0,o.useState)([]),F=(0,o.useRef)(null),[R,_]=(0,o.useState)("pdf"),[P,I]=(0,o.useState)("inbox"),[U,L]=(0,o.useState)([]),[M,D]=(0,o.useState)(""),J=(0,o.useMemo)(()=>f&&!!y&&!!N&&!!M,[f,y,N,M]);function G(e,t){O(n=>[...n,{type:e,message:t}])}async function H(){if(c){h(!0),E(null);try{let{authUrl:e}=await d(c,"offline_access Mail.Read User.Read",!0,"consumers");G("info","Opening Microsoft sign-in window..."),F.current=window.open(e,"outlook-oauth","width=600,height=700"),setTimeout(()=>X(),2500)}catch(e){G("error",(null==e?void 0:e.message)||"Failed to start OAuth");try{let e=function(e,t,n,a){let o=i()[0],s=new URLSearchParams({action:"start",uid:encodeURIComponent(e),auto:"1"});return t&&s.set("scopes",t),n&&s.set("force_consent","1"),a&&s.set("tenant",a),"".concat(o,"/outlookOAuth?").concat(s.toString())}(c,"offline_access Mail.Read User.Read",!0,"consumers");G("info","Opening fallback start page..."),F.current=window.open(e,"outlook-oauth","width=600,height=700"),setTimeout(()=>X(),3e3)}catch(e){}}finally{h(!1)}}}async function X(){if(c)try{let e=await u(c);g(!!e.connected),v(e.email),b(e.displayName),e.connected?G("info","Outlook connected"):G("info","Not connected yet")}catch(e){G("error",(null==e?void 0:e.message)||"Failed to check status")}}async function z(){if(!c||!y||!N)return;if(!M){G("error","يرجى اختيار ملف وظيفي أولاً ليتم الفحص بناءً عليه.");return}k(!0),E(null);let e=U.find(e=>e.id===M),t=e?e.title||e.id:M;G("info","سيتم الفحص حسب الملف الوظيفي: ".concat(t," (").concat(M,").")),G("info","Fetching ".concat(R.toUpperCase()," from ").concat(P," and creating documents..."));try{let e=await x(c,y,N,{fileType:R,folder:P,jobProfileId:M||void 0});E(e.createdCount),G("info","Created ".concat(e.createdCount," documents from attachments"));let t=null==e?void 0:e.stats;if(t&&(t.jobProfileId||t.folder||t.fileType)){let e=t.jobProfileId?String(t.jobProfileId):M,n=t.folder?String(t.folder):P,a=t.fileType?String(t.fileType):R;G("info","JobProfileId: ".concat(e,", Folder: ").concat(n,", FileType: ").concat(a))}if(null==e?void 0:e.stats){var n,a;let t=e.stats;if(G("info","Scanned ".concat(null!==(n=t.scannedAttachmentsCount)&&void 0!==n?n:0," attachments across ").concat(null!==(a=t.messagesCount)&&void 0!==a?a:0," messages.")),"number"==typeof t.attemptedCreatesCount&&G("info","Attempted to create ".concat(t.attemptedCreatesCount," documents.")),t.bucket&&G("info","Storage bucket: ".concat(t.bucket)),t.env){let e=t.env.FIREBASE_STORAGE_EMULATOR_HOST||t.env.STORAGE_EMULATOR_HOST||"",n=t.env.FIRESTORE_EMULATOR_HOST||"";(e||n)&&G("info","Emulators — Firestore: ".concat(n||"n/a",", Storage: ").concat(e||"n/a"))}}if(null==e?void 0:e.samples){let t=e.samples,n=(e,t)=>{if(!e||0===e.length)return;let n=e.slice(0,5).map(e=>"".concat(e.name," (").concat(e.contentType||"unknown",")")).join(", ");G("info","".concat(t,": ").concat(n))};n(t.all,"Returned attachments (sample)"),n(t.accepted,"Accepted attachments (sample)")}if((null==e?void 0:e.errorCount)&&Array.isArray(e.errors)&&e.errors.length){let t=e.errors.slice(0,5).map(e=>"".concat(e.stage,": ").concat(e.message));G("error","Errors (".concat(e.errorCount,"): ").concat(t.join("; ")))}}catch(e){G("error",(null==e?void 0:e.message)||"Failed to fetch attachments")}finally{k(!1)}}return((0,o.useEffect)(()=>{if(!t)return;let e=!0;return(async()=>{try{var t;let n=(0,s.kL)(),a=null===(t=n.currentUser)||void 0===t?void 0:t.uid;if(!a){G("error","غير مصرح: الرجاء تسجيل الدخول");return}if(!e)return;r(a);let o=await u(a);g(!!o.connected),v(o.email),b(o.displayName);try{let t=(0,s.X9)(),n=await (0,l.getDocs)((0,l.query)((0,l.collection)(t,"jobProfiles"),(0,l.where)("uid","==",a),(0,l.limit)(100))),o=[];n.forEach(e=>o.push({id:e.id,...e.data()})),o.sort((e,t)=>String(e.title||e.id).localeCompare(String(t.title||t.id))),e&&L(o)}catch(e){G("error",(null==e?void 0:e.message)||"Failed to load job profiles")}}catch(e){G("error",(null==e?void 0:e.message)||"Failed to initialize user session")}})(),()=>{e=!1}},[t]),(0,o.useEffect)(()=>{function e(e){var t;(null==e?void 0:null===(t=e.data)||void 0===t?void 0:t.type)==="outlook-connected"&&X()}return window.addEventListener("message",e),()=>window.removeEventListener("message",e)},[]),t)?(0,a.jsx)("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40",children:(0,a.jsxs)("div",{className:"w-full max-w-xl rounded-lg border bg-white p-4 shadow-xl",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsx)("h3",{className:"text-sm font-semibold",children:"Connect Outlook"}),(0,a.jsx)("button",{onClick:n,className:"rounded px-2 py-1 text-xs hover:bg-gray-100",children:"Close"})]}),(0,a.jsxs)("div",{className:"mt-4 space-y-4 text-sm",children:[(0,a.jsxs)("section",{children:[(0,a.jsx)("div",{className:"mb-2 text-xs font-medium text-gray-700",children:"Authentication"}),(0,a.jsxs)("div",{className:"flex items-center justify-between gap-3",children:[(0,a.jsx)("div",{className:"text-xs text-gray-600",children:"Microsoft Outlook"}),(0,a.jsx)("button",{onClick:H,disabled:m,className:"rounded-md border bg-white px-3 py-2 text-xs hover:bg-gray-50 disabled:opacity-60",children:m?"Connecting…":"Connect with Microsoft Outlook"})]}),f&&(0,a.jsxs)("div",{className:"mt-2 inline-flex items-center gap-2 rounded-md bg-green-50 px-2 py-1 text-xs text-green-700",children:[(0,a.jsx)("span",{className:"font-medium",children:"Connected"}),(0,a.jsx)("span",{children:p||j||"Account linked"})]})]}),(0,a.jsxs)("section",{children:[(0,a.jsx)("div",{className:"mb-2 text-xs font-medium text-gray-700",children:"Date range"}),(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-3",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"mb-1 block text-xs text-gray-600",children:"From date"}),(0,a.jsx)("input",{type:"date",value:y,onChange:e=>w(e.target.value),className:"w-full rounded border p-2 text-xs"})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"mb-1 block text-xs text-gray-600",children:"To date"}),(0,a.jsx)("input",{type:"date",value:N,onChange:e=>C(e.target.value),className:"w-full rounded border p-2 text-xs"})]})]})]}),(0,a.jsxs)("section",{children:[(0,a.jsx)("div",{className:"mb-2 text-xs font-medium text-gray-700",children:"Filters"}),(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-3",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"mb-1 block text-xs text-gray-600",children:"File type"}),(0,a.jsxs)("select",{value:R,onChange:e=>_(e.target.value),className:"w-full rounded border p-2 text-xs",children:[(0,a.jsx)("option",{value:"pdf",children:"PDF"}),(0,a.jsx)("option",{value:"doc",children:"DOC"}),(0,a.jsx)("option",{value:"docx",children:"DOCX"}),(0,a.jsx)("option",{value:"txt",children:"TXT"}),(0,a.jsx)("option",{value:"all",children:"All"})]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"mb-1 block text-xs text-gray-600",children:"Folder"}),(0,a.jsxs)("select",{value:P,onChange:e=>I(e.target.value),className:"w-full rounded border p-2 text-xs",children:[(0,a.jsx)("option",{value:"inbox",children:"Inbox"}),(0,a.jsx)("option",{value:"junkemail",children:"Junk Email"}),(0,a.jsx)("option",{value:"archive",children:"Archive"}),(0,a.jsx)("option",{value:"all",children:"All folders"})]})]})]})]}),(0,a.jsxs)("section",{children:[(0,a.jsx)("div",{className:"mb-2 text-xs font-medium text-gray-700",children:"Job Profile"}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"mb-1 block text-xs text-gray-600",children:"Select a job profile to evaluate against"}),(0,a.jsxs)("select",{value:M,onChange:e=>D(e.target.value),className:"w-full rounded border p-2 text-xs",children:[(0,a.jsx)("option",{value:"",children:"— Select Job Profile —"}),U.map(e=>(0,a.jsx)("option",{value:e.id,children:e.title||e.id},e.id))]})]})]}),(0,a.jsxs)("section",{children:[(0,a.jsx)("div",{className:"mb-2 text-xs font-medium text-gray-700",children:"Actions"}),(0,a.jsxs)("div",{className:"flex items-center justify-between gap-3",children:[(0,a.jsxs)("div",{className:"inline-flex items-center gap-2 rounded-md px-2 py-1 text-xs ".concat(f?"bg-green-50 text-green-700":"bg-gray-50 text-gray-700"),children:[(0,a.jsx)("span",{className:"font-medium",children:f?"Connected":"Not connected"}),f&&(0,a.jsx)("span",{children:p||j||"Account"})]}),(0,a.jsx)("button",{onClick:z,disabled:!J||S,className:"rounded-md bg-indigo-600 px-3 py-2 text-xs text-white hover:bg-indigo-700 disabled:opacity-60",children:S?"Fetching…":"Fetch Attachments"})]}),null!==T&&(0,a.jsxs)("div",{className:"mt-2 text-xs text-gray-700",children:["Created ",T," documents."]})]}),(0,a.jsxs)("section",{children:[(0,a.jsx)("div",{className:"mb-2 text-xs font-medium text-gray-700",children:"Status"}),(0,a.jsx)("div",{className:"rounded-md border bg-gray-50 p-3",children:0===A.length?(0,a.jsx)("div",{className:"text-xs text-gray-600",children:"Loading messages…"}):(0,a.jsx)("ul",{className:"space-y-1 text-xs",children:A.map((e,t)=>(0,a.jsx)("li",{className:"error"===e.type?"text-red-700":"text-gray-800",children:e.message},t))})}),(0,a.jsxs)("div",{className:"mt-2 flex items-center gap-2",children:[(0,a.jsx)("button",{onClick:n,className:"rounded-md border bg-white px-3 py-2 text-xs hover:bg-gray-50",children:"Close"}),(0,a.jsx)("button",{onClick:X,className:"rounded-md border bg-white px-3 py-2 text-xs hover:bg-gray-50",children:"Retry"}),(0,a.jsx)("button",{onClick:n,className:"rounded-md bg-indigo-600 px-3 py-2 text-xs text-white hover:bg-indigo-700",children:"Done"})]})]})]})]})}):null}}}]);