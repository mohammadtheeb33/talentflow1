(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[935],{1568:function(e,t,s){Promise.resolve().then(s.bind(s,7172))},7172:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return c}});var i=s(7437),l=s(2265),a=s(6003),r=s(6410),n=s(5978),d=s(62);function o(e){let{isOpen:t,onClose:s}=e,[a,o]=(0,l.useState)([]),[c,u]=(0,l.useState)(""),[x,m]=(0,l.useState)(""),[h,v]=(0,l.useState)(""),[f,p]=(0,l.useState)(!1),[g,b]=(0,l.useState)(0),[y,j]=(0,l.useState)(0),[w,N]=(0,l.useState)([]),C=(0,l.useMemo)(()=>!!c&&!!x&&!!h,[c,x,h]);function k(e,t){N(s=>[...s,{type:e,message:t}])}async function A(){if(C)try{var e;let t=(0,r.kL)(),s=null===(e=t.currentUser)||void 0===e?void 0:e.uid;if(!s){k("error","غير مصرح: الرجاء تسجيل الدخول");return}p(!0),b(0),j(0),N([]),k("info","بدء الفحص الجماعي…");let i=(0,r.X9)(),l=(0,r.bH)(),o=n.Timestamp.fromDate(new Date("".concat(x,"T00:00:00"))),u=n.Timestamp.fromDate(new Date("".concat(h,"T23:59:59"))),m=(0,n.query)((0,n.collection)(i,"cvs"),(0,n.where)("uid","==",s),(0,n.where)("createdAt",">=",o),(0,n.where)("createdAt","<=",u),(0,n.orderBy)("createdAt"),(0,n.limit)(500)),v=[];try{(await (0,n.getDocs)(m)).forEach(e=>v.push({id:e.id,data:e.data()}))}catch(r){if(!("string"==typeof(null==r?void 0:r.message)&&r.message.toLowerCase().includes("requires an index")))throw r;k("info","الاستعلام يتطلب فهرسًا مركّبًا (uid + createdAt). تم استخدام آلية احتياطية مؤقتًا؛ يُنصح بإنشاء الفهرس المقترح.");let e=(0,n.query)((0,n.collection)(i,"cvs"),(0,n.where)("uid","==",s),(0,n.limit)(500)),t=await (0,n.getDocs)(e),l=new Map;t.forEach(e=>{let t=e.data();l.set(e.id,t)});let a=(0,n.query)((0,n.collection)(i,"cvs"),(0,n.where)("userId","==",s),(0,n.limit)(500));(await (0,n.getDocs)(a)).forEach(e=>{let t=e.data();l.set(e.id,t)}),v=Array.from(l.entries()).map(e=>{let[t,s]=e;return{id:t,data:s}}).filter(e=>{let{data:t}=e,s=null==t?void 0:t.createdAt;if(!s||"function"!=typeof(null==s?void 0:s.toMillis))return!1;let i=s.toMillis();return i>=o.toMillis()&&i<=u.toMillis()}).sort((e,t)=>{var s,i,l,a,r,n,d,o;let c=null!==(d=null===(l=e.data)||void 0===l?void 0:null===(i=l.createdAt)||void 0===i?void 0:null===(s=i.toMillis)||void 0===s?void 0:s.call(i))&&void 0!==d?d:0,u=null!==(o=null===(n=t.data)||void 0===n?void 0:null===(r=n.createdAt)||void 0===r?void 0:null===(a=r.toMillis)||void 0===a?void 0:a.call(r))&&void 0!==o?o:0;return c-u}).slice(0,500)}k("info","تم العثور على ".concat(v.length," سير ذاتية ضمن الفترة.")),j(v.length);let f=a.find(e=>e.id===c),g=f?f.title||f.id:void 0;for(let e of v){let{id:t,data:s}=e;b(e=>e+1);let a=null==s?void 0:s.storagePath;if(!a){k("error","CV ".concat(t,": لا يحتوي على ملف في التخزين؛ تمّ تجاوزه."));continue}try{if(await (0,n.updateDoc)((0,n.doc)(i,"cvs",t),{jobProfileId:c,jobTitle:g||null,jobProfile:f?{...f,updatedAt:(0,n.serverTimestamp)()}:null,updatedAt:(0,n.serverTimestamp)()}),(null==s?void 0:s.parsed)&&"scanned"===String((null==s?void 0:s.status)||""))k("info","CV ".concat(t,": محدّث لملف الوظيفة وسيُعاد التقييم."));else{let e=await (0,r.mi)(a),s=await fetch(e);if(!s.ok)throw Error("فشل تنزيل الملف (".concat(s.status,")"));let o=await s.blob(),c=(0,d.ref)(l,a);await (0,d.uploadBytes)(c,o,{contentType:o.type||"application/pdf",cacheControl:"public, max-age=3600"}),await (0,n.updateDoc)((0,n.doc)(i,"cvs",t),{status:"pending",storagePath:a,rescanRequestedAt:(0,n.serverTimestamp)(),updatedAt:(0,n.serverTimestamp)()}),k("info","CV ".concat(t,": أُعيد رفع الملف لإعادة الفحص."))}}catch(e){k("error","CV ".concat(t,": ").concat((null==e?void 0:e.message)||"تعذّر الفحص"))}}k("info","اكتمل الفحص الجماعي.")}catch(e){k("error",(null==e?void 0:e.message)||"تعذّر تنفيذ الفحص الجماعي")}finally{p(!1)}}return((0,l.useEffect)(()=>{if(!t)return;let e=!0;return(async()=>{try{var t;let s=(0,r.kL)(),i=null===(t=s.currentUser)||void 0===t?void 0:t.uid;if(!i){k("error","غير مصرح: الرجاء تسجيل الدخول");return}let l=(0,r.X9)(),a=await (0,n.getDocs)((0,n.query)((0,n.collection)(l,"jobProfiles"),(0,n.where)("uid","==",i),(0,n.limit)(200))),d=[];a.forEach(e=>d.push({id:e.id,...e.data()})),d.sort((e,t)=>String(e.title||e.id).localeCompare(String(t.title||t.id))),e&&o(d)}catch(e){k("error",(null==e?void 0:e.message)||"تعذّر تحميل ملفات الوظائف")}})(),()=>{e=!1}},[t]),t)?(0,i.jsx)("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40",children:(0,i.jsxs)("div",{className:"w-full max-w-xl rounded-lg border bg-white p-4 shadow-xl",children:[(0,i.jsxs)("div",{className:"flex items-center justify-between",children:[(0,i.jsx)("h3",{className:"text-sm font-semibold",children:"فحص جماعي للسير الذاتية"}),(0,i.jsx)("button",{onClick:s,className:"rounded px-2 py-1 text-xs hover:bg-gray-100",children:"إغلاق"})]}),(0,i.jsxs)("div",{className:"mt-4 space-y-4 text-sm",children:[(0,i.jsxs)("section",{children:[(0,i.jsx)("div",{className:"mb-2 text-xs font-medium text-gray-700",children:"الملف الوظيفي"}),(0,i.jsxs)("select",{value:c,onChange:e=>u(e.target.value),className:"w-full rounded border p-2 text-xs",children:[(0,i.jsx)("option",{value:"",children:"— اختر ملفًا وظيفيًا —"}),a.map(e=>(0,i.jsx)("option",{value:e.id,children:e.title||e.id},e.id))]})]}),(0,i.jsxs)("section",{children:[(0,i.jsx)("div",{className:"mb-2 text-xs font-medium text-gray-700",children:"الفترة الزمنية"}),(0,i.jsxs)("div",{className:"grid grid-cols-2 gap-3",children:[(0,i.jsxs)("div",{children:[(0,i.jsx)("label",{className:"mb-1 block text-xs text-gray-600",children:"من تاريخ"}),(0,i.jsx)("input",{type:"date",value:x,onChange:e=>m(e.target.value),className:"w-full rounded border p-2 text-xs"})]}),(0,i.jsxs)("div",{children:[(0,i.jsx)("label",{className:"mb-1 block text-xs text-gray-600",children:"إلى تاريخ"}),(0,i.jsx)("input",{type:"date",value:h,onChange:e=>v(e.target.value),className:"w-full rounded border p-2 text-xs"})]})]})]}),(0,i.jsxs)("section",{children:[(0,i.jsx)("div",{className:"mb-2 text-xs font-medium text-gray-700",children:"الإجراء"}),(0,i.jsxs)("div",{className:"flex items-center justify-between gap-3",children:[(0,i.jsxs)("div",{className:"text-xs text-gray-600",children:["المطابقات: ",y," | المُعالَجة: ",g]}),(0,i.jsx)("button",{onClick:A,disabled:!C||f,className:"rounded-md bg-indigo-600 px-3 py-2 text-xs text-white hover:bg-indigo-700 disabled:opacity-60",children:f?"جارٍ الفحص…":"فحص السير الذاتية"})]})]}),(0,i.jsxs)("section",{children:[(0,i.jsx)("div",{className:"mb-2 text-xs font-medium text-gray-700",children:"السجل"}),(0,i.jsx)("div",{className:"rounded-md border bg-gray-50 p-3",children:0===w.length?(0,i.jsx)("div",{className:"text-xs text-gray-600",children:"لا توجد رسائل بعد."}):(0,i.jsx)("ul",{className:"space-y-1 text-xs",children:w.map((e,t)=>(0,i.jsx)("li",{className:"error"===e.type?"text-red-700":"text-gray-800",children:e.message},t))})}),(0,i.jsx)("div",{className:"mt-2 flex items-center gap-2",children:(0,i.jsx)("button",{onClick:s,className:"rounded-md border bg-white px-3 py-2 text-xs hover:bg-gray-50",children:"إغلاق"})})]})]})]})}):null}function c(){let[e,t]=(0,l.useState)(!1);return(0,i.jsxs)("main",{className:"mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-8",children:[(0,i.jsx)(a.Z,{onCheckCv:()=>t(!0)}),(0,i.jsx)(o,{isOpen:e,onClose:()=>t(!1)})]})}}},function(e){e.O(0,[358,139,2,648,3,971,117,744],function(){return e(e.s=1568)}),_N_E=e.O()}]);